automation:
  - alias: "HÃ¤lytys: Revontulet nÃ¤kyvissÃ¤"
    description: "Ilmoittaa jos revontulia on ja taivas on selkeÃ¤"
    trigger:
      - platform: numeric_state
        entity_id: sensor.aurora_aurora_visibility_visibility
        above: 49
    condition:
      - condition: and
        conditions:
          # 1. Onko aurinko laskenut? (PimeÃ¤Ã¤)
          - condition: state
            entity_id: sun.sun
            state: "below_horizon"
          # 2. Onko sÃ¤Ã¤ selkeÃ¤ tai puolipilvinen?
          - condition: template
            value_template: >
              {{ states('weather.forecast_home') in ['sunny', 'clear-night', 'partlycloudy'] }}
          # 3. EstetÃ¤Ã¤n viestitulva (vÃ¤hintÃ¤Ã¤n 2h edellisestÃ¤ hÃ¤lytyksestÃ¤)
          - condition: template
            value_template: >
              {{ (as_timestamp(now()) - as_timestamp(state_attr('automation.halytys_revontulet_nakyvissa', 'last_triggered') | default(0))) > 7200 }}
    action:
      - service: notify.vainola
        data:
          title: "ðŸŒŒ RevontulihÃ¤lytys!"
          message: >
            Nyt kannattaa katsoa taivaalle! 
            NÃ¤kyvyysennuste: {{ states('sensor.aurora_aurora_visibility_visibility') }}% 
            SÃ¤Ã¤: {{ states('weather.forecast_home') }}.
