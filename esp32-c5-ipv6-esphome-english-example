# ESP32-C5 - via ESPHome to Home Assistant
# IPv6 enabled, IPv4 also if left enabled for the VLAN
# Bonus: two text sensors that report IP addresses to Home Assistant
# Note: OTA, API, and NTP settings are not included here; they are read via packages

substitutions:
  node_name: c5-testing
  friendly_name: "C5 Testing"

esphome:
  name: ${node_name}
  friendly_name: ${friendly_name}
  platformio_options:
    # SSL/TLS (TLS 1.2/1.3) support for TCP connections enabled
    build_flags: "-DASYNC_TCP_SSL_ENABLED=1"

esp32:
  board: esp32-c5-devkitc-1
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_LWIP_IPV6: "y"
      CONFIG_LWIP_IPV6_AUTOCONFIG: "y"
#      CONFIG_LWIP_IPV4: "n"           # Disable IPv4 support in LWIP - commented out for now, still enabled for safety, disable only per VLAN if needed
#      CONFIG_LWIP_DHCP: "n"           # Prevent IPv4 DHCP requests - commented out for now, disable only per VLAN if needed

wifi:
  power_save_mode: none
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: false

# --- Include packages for OTA, API key, and SNTP ---
packages:
  - !include common/otaapi.yaml
  - !include common/time.yaml # remember that SNTP settings also need to support IPv6

# --- BLE + proxy ---
esp32_ble:
  # scanning automatically enabled with proxy
bluetooth_proxy:

# --- Ruuvi BLE sensors ---
# comment out if you want raw data to go to Home Assistant
ruuvi_ble: 

# --- Logger ---
logger:
  level: VERY_VERBOSE
  # no UART, API/Telnet only
  baud_rate: 0   

# Enable IPv6 network settings
network:
  enable_ipv6: true
  # Wait until the device has at least a Link-Local (fe80::) 
  # and a Global address before considering connection ready.
  min_ipv6_addr_count: 2

text_sensor:

  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IPv4 Address"

  - platform: template
    name: "${friendly_name} IPv6 Addresses"
    id: ipv6_addresses
    icon: "mdi:ip-network"
    update_interval: 60s
    lambda: |-
      std::string addresses = "";
      for (auto const& addr : network::get_ip_addresses()) {
        if (addr.is_ip6()) {
          if (!addresses.empty()) addresses += ", ";
          addresses += addr.str(); // ESPHome way to convert IP to string
        }
      }
      return addresses;
